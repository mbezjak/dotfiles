#!/bin/bash
#

set -o errexit

function color {
    case "$1" in
        red)    tput -Txterm setaf 1 ;;
        green)  tput -Txterm setaf 2 ;;
        yellow) tput -Txterm setaf 3 ;;
        reset)  tput -Txterm sgr0    ;;
        *)      echo "Unknown color: $1"; die ;;
    esac

    return 0
}
function error { color red; echo "$@"; color reset;   }
function msg   { color green; echo "$@"; color reset; }
function die   { exit 1; }
function fail  { error "$@"; die; }
function usage {
local prog=$(basename $0)
cat >&2 <<EOF
$prog - install the plugin via 'grails.plugins.location' for easier testing

SYNOPSIS
    $prog plugin_name

Current directory should be grails application in which given plugin should be
installed!
EOF
}


declare -r plugin="$1"
declare -r dir="../$plugin"
declare -r config=grails-app/conf/BuildConfig.groovy
declare -r aprop=application.properties


# sanity checks
[[ -z "$plugin" ]] && usage && die
[[ ! -d "$dir" ]]  && fail "Plugin not found in '$dir'"
[[ ! -f $config ]] && fail "'$config' not found"


declare -r pluginname=$(grep app.name "$dir/$aprop" | awk -F= '{print $2}')
declare -r key="grails.plugin.location.'$pluginname'"
declare -r line="$key = '$dir'"

declare -r installed=$(grep --count --fixed-strings "$key" $config)
if [[ $installed == 0 ]]; then
    if [[ -f "$dir/$config" ]]; then
        # grails doesn't work when `mavenRepo` is being passed a closure
        sed -i -e 's/\(mavenRepo [^,]\+\),.*/\1/g' "$dir/$config"
    fi
    sed -i -e "/':$pluginname:[a-zA-Z0-9.-]\+'/d" $config
    echo "$line" >> $config
    msg "$line"
else
    sed -i -e "/$key/d" $config
    echo "Removed: $key"
fi


exit 0
