#!/bin/bash
#
# Interoperability of maven deploy with mercurial repository.

project="$PWD"
[[ ! -f pom.xml ]] && {
    echo "$project isn't a maven project" >&2
    exit 1
}
[[ ! -d .hg ]] && {
    echo "$project isn't a mercurial project" >&2
    exit 2
}

version=$(xpath pom.xml '//project/version/text()' 2> /dev/null)
[[ -z "$version" ]] && echo 'Missing version in pom.xml' >&2 && exit 3
[[ -n $(hg hastag "$version") ]] && {
    echo "$project is already released under '$version'" >&2
    exit 4
}

set -o errexit

[[ "$version" != *-SNAPSHOT ]] && {
    [[ $(hg dirty) -ne 0 ]] && {
        echo "Project has uncommited changes. Do a 'hg commit' first!" >&2
        exit 5
    }
    hg tag "$version"
    hg push
    echo # newline
}

mvn -Pdeploy

exit 0
