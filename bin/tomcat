#!/bin/bash
#

print_usage() {
local prog=$(basename $0)
cat >&2 << EOF
$prog - operate on tomcat instance set by environmental variable CATALINA_HOME

SYNOPSIS
    $prog start
    $prog stop
    $prog restart
    $prog log
    $prog clean
    $prog deploy WAR_FILE [CONTEXT_NAME]
EOF

exit 1
}

[[ -z "$CATALINA_HOME" ]] && {
    echo "Environmental variable CATALINA_HOME must be set" >&2
    exit 2
}
[[ ! -d "$CATALINA_HOME" ]] && {
    echo "Directory from environmental variable CATALINA_HOME must exist" >&2
    exit 3
}

# cd to contain log files with relative path
start()   { (cd "$CATALINA_HOME"; bin/startup.sh;)  }
stop()    { (cd "$CATALINA_HOME"; bin/shutdown.sh;) }
restart() { stop; start; }
log()     { tail -F "$CATALINA_HOME/logs/catalina.out"; }
clean() {
    rm -rf "$CATALINA_HOME"/*.log
    rm -rf "$CATALINA_HOME"/{temp,work,logs}/*
    rm -rf "$CATALINA_HOME/conf/Catalina"
}
deploy() {
    [[ ! -f "$1" && "$1" != *.war ]] && print_usage

    stop &> /dev/null
    context=${2:-$(basename "$1")}
    context=${context%\.war}
    rm -rf "$CATALINA_HOME/webapps/$context"
    rm -f "$CATALINA_HOME/webapps/${context}.war"
    cp --verbose "$1" "$CATALINA_HOME/webapps/${context}.war"
    start
}

case "$1" in
start)   start ;;
stop)    stop ;;
restart) restart ;;
log)     log ;;
clean)   clean ;;
deploy)  deploy "$2" "$3" ;;
*)       print_usage ;;
esac

exit 0
