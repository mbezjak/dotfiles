#!/bin/bash
#
# Test if grails project has plugin given as argument $1.
# Lists all installed plugins if $1 isn't set.
#
# example:
#  $ grailshasplugin foo

set -o errexit

declare -r plugin="$1"
declare -r project=$(grailsproject directory)
declare -r grailsVersion=$(grailsproject grails)

function list-in {
    # http://stackoverflow.com/questions/2096490/print-second-last-column-field-in-awk
    # http://stackoverflow.com/questions/6271348/regex-to-replace-last-occurrence-of-a-string-in-each-line
    find "$1" -maxdepth 1 -mindepth 1 -printf '%f\n' | \
        sed -e 's|-\([^-]*\)$| \1|'
}

function list {
    local -r inTarget=target/plugins
    local -r inDotGrails="$HOME/.grails/$grailsVersion/projects/$project/plugins"

    if   [[ -d $inTarget ]];    then list-in $inTarget
    elif [[ -d $inDotGrails ]]; then list-in $inDotGrails
    fi

    return 0
}

function from-code {
    grailsproject | \
        awk '/^plugin /{ print $2, $3 }' | \
        grep -v 'latest.release'
}


# output: project_name plugin_version plugin_name
(list; from-code) | sort | uniq | \
    awk -v project="$project" '/^'"$plugin"'/{ print project, $2, $1 }' | \
    column -t

exit 0
